name: Email changelog from README (pretty text)

on:
  push:
    branches: ["main"]
    paths:
      - "README.md"
      - "standards.csv"

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract latest changelog section from README (pretty text)
        id: extract
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e

          python - << 'PY'
          import re
          from pathlib import Path
          import os

          text = Path("README.md").read_text(encoding="utf-8")

          # 1) '## 변경 내역' 섹션 추출 (README는 변경내역만 존재한다고 가정)
          m = re.search(r"^##\s*변경\s*내역\s*$([\s\S]*)", text, re.MULTILINE)
          if not m:
              raise SystemExit("README.md에 '## 변경 내역' 섹션이 없습니다. (형식: '## 변경 내역')")

          changelog = m.group(1).strip()

          # 2) 가장 위에 있는 최신 날짜 블록 1개 추출
          #    블록 정의:
          #    ### YYYY-MM-DD
          #    - ...
          #    - ...
          block_re = re.compile(
              r"^###\s*(\d{4}-\d{2}-\d{2})\s*$\n"       # date header
              r"((?:^\-\s+.*$\n?)*)",                   # bullets (0+ lines)
              re.MULTILINE
          )

          blocks = list(block_re.finditer(changelog))
          if not blocks:
              raise SystemExit("변경 내역 섹션에서 '### YYYY-MM-DD' 블록을 찾지 못했습니다.")

          # README 규칙: 최신 항목이 최상단
          latest = blocks[0]
          latest_date = latest.group(1)
          bullets_raw = latest.group(2) or ""

          # 3) bullet 라인 정리
          bullet_lines = []
          for ln in bullets_raw.splitlines():
              ln = ln.strip()
              if ln.startswith("- "):
                  bullet_lines.append(ln[2:].strip())

          pretty_items = [f"• {b}" for b in bullet_lines if b]

          # 4) 링크 구성
          server_url = os.environ.get("GITHUB_SERVER_URL", "https://github.com")
          repo = os.environ.get("GITHUB_REPOSITORY", "")
          repo_url = f"{server_url}/{repo}" if repo else server_url
          readme_url = f"{server_url}/{repo}/blob/main/README.md" if repo else ""
          csv_url = f"{server_url}/{repo}/blob/main/standards.csv" if repo else ""

          # 5) 최종 텍스트 본문 생성 (Markdown 없이)
          out = []
          out.append("표준 문서 변경 알림")
          out.append("")
          out.append(f"날짜: {latest_date}")
          out.append("")
          out.append("변경 내역:")
          if pretty_items:
              out.extend(pretty_items)
          else:
              out.append("• (변경 항목이 없습니다. README 형식을 확인하세요: '### YYYY-MM-DD' 아래 '- ...' 목록)")
          out.append("")
          out.append("바로가기:")
          if repo_url:
              out.append(f"- 저장소: {repo_url}")
          if readme_url:
              out.append(f"- README: {readme_url}")
          if csv_url:
              out.append(f"- CSV: {csv_url}")

          pretty_text = "\n".join(out) + "\n"

          Path("latest_changelog_pretty.txt").write_text(pretty_text, encoding="utf-8")
          Path("latest_date.txt").write_text(latest_date + "\n", encoding="utf-8")

          print("Latest changelog date:", latest_date)
          PY

      - name: Read extracted text
        id: readtxt
        run: |
          echo "LATEST_DATE=$(cat latest_date.txt)" >> $GITHUB_ENV
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          cat latest_changelog_pretty.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "표준 문서 변경 알림 (${{ env.LATEST_DATE }})"
          to: ${{ secrets.MAIL_TO }}
          from: "standards-version-tracker <${{ secrets.SMTP_USERNAME }}>"
          body: |
            ${{ env.CHANGELOG }}
