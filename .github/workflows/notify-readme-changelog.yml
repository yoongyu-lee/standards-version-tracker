name: Email changelog from README (pretty text)

on:
  workflow_run:
    # ✅ Must match the exact `name:` of your update workflow
    workflows: ["Update standards versions"]
    types: [completed]

permissions:
  contents: read

jobs:
  notify:
    # ✅ Send only when the update workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (latest main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Extract latest changelog section from README (pretty text)
        id: extract
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e

          python3 - << 'PY'
          import re
          from pathlib import Path
          import os
          from datetime import datetime, timezone, timedelta

          text = Path("README.md").read_text(encoding="utf-8")

          # (KST) 날짜 표기 보정용
          KST = timezone(timedelta(hours=9))
          today_kst = datetime.now(KST).strftime("%Y-%m-%d")

          # 1) '## 변경 내역' 섹션 추출
          m = re.search(r"^##\s*변경\s*내역\s*$([\s\S]*)", text, re.MULTILINE)
          if not m:
              latest_date = "NO_CHANGE"
              pretty_items = []
          else:
              changelog = m.group(1).strip()

              # 2) 가장 위에 있는 최신 날짜 블록 1개 추출
              #    ### YYYY-MM-DD
              #    (빈 줄)
              #    #### Version updates (선택적)
              #    - ...
              # lookahead에서 $ 대신 \Z 사용: MULTILINE에서 $는 줄 끝에도 매칭해
              # 블록 본문이 빈 문자열로 잡히는 문제 방지
              block_re = re.compile(
                  r"^###\s*(\d{4}-\d{2}-\d{2})\s*$"         # date header
                  r"([\s\S]*?)"                              # everything until next ### or end
                  r"(?=^###\s*\d{4}-\d{2}-\d{2}\s*$|\Z)",   # next date block or end-of-string only
                  re.MULTILINE
              )

              blocks = list(block_re.finditer(changelog))
              if not blocks:
                  latest_date = "NO_CHANGE"
                  pretty_items = []
              else:
                  # README 규칙: 최신 항목이 최상단
                  latest = blocks[0]
                  latest_date = latest.group(1)
                  block_content = latest.group(2) or ""

                  # 3) bullet 라인 정리 (서브헤더 무시하고 실제 항목만 추출)
                  bullet_lines = []
                  for ln in block_content.splitlines():
                      ln = ln.strip()
                      # #### Version updates 같은 서브헤더는 건너뛰고
                      # 실제 변경 항목만 추출
                      if ln.startswith("- ") and not ln.startswith("- ####"):
                          bullet_lines.append(ln[2:].strip())

                  pretty_items = [f"• {b}" for b in bullet_lines if b]

          # 4) 링크 구성
          server_url = os.environ.get("GITHUB_SERVER_URL", "https://github.com")
          repo = os.environ.get("GITHUB_REPOSITORY", "")
          repo_url = f"{server_url}/{repo}" if repo else server_url
          readme_url = f"{server_url}/{repo}/blob/main/README.md" if repo else ""
          csv_url = f"{server_url}/{repo}/blob/main/standards.csv" if repo else ""

          # 5) 최종 텍스트 본문 생성 (Markdown 없이)
          out = []
          out.append("표준 문서 변경 알림")
          out.append("")

          if latest_date == "NO_CHANGE":
              out.append(f"날짜: {today_kst} (변경내역 없음)")
          else:
              out.append(f"날짜: {latest_date}")

          out.append("")
          out.append("변경 내역:")

          # ✅ 변경내역이 없으면 '변경내역 없음'으로 통일
          if pretty_items:
              out.extend(pretty_items)
          else:
              out.append("• 변경내역 없음")

          out.append("")
          out.append("바로가기:")
          if repo_url:
              out.append(f"- 저장소: {repo_url}")
          if readme_url:
              out.append(f"- README: {readme_url}")
          if csv_url:
              out.append(f"- CSV: {csv_url}")

          pretty_text = "\n".join(out) + "\n"

          Path("latest_changelog_pretty.txt").write_text(pretty_text, encoding="utf-8")
          Path("latest_date.txt").write_text(latest_date + "\n", encoding="utf-8")
          Path("has_changes.txt").write_text("1" if (latest_date != "NO_CHANGE" and pretty_items) else "0", encoding="utf-8")

          print("Latest changelog date:", latest_date)
          print("Has changes:", "1" if (latest_date != "NO_CHANGE" and pretty_items) else "0")
          PY

      - name: Check if there are changes
        id: check_changes
        run: |
          HAS_CHANGES=$(cat has_changes.txt)
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          if [ "$HAS_CHANGES" = "0" ]; then
            echo "No changes detected. Skipping email notification."
            exit 0
          fi

      - name: Read extracted text
        id: readtxt
        if: steps.check_changes.outputs.has_changes == '1'
        run: |
          echo "LATEST_DATE=$(cat latest_date.txt)" >> $GITHUB_ENV
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          cat latest_changelog_pretty.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        if: steps.check_changes.outputs.has_changes == '1'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "표준 문서 변경 알림 (${{ env.LATEST_DATE }})"
          to: ${{ secrets.MAIL_TO }}
          from: "standards-version-tracker <${{ secrets.SMTP_USERNAME }}>"
          body: |
            ${{ env.CHANGELOG }}