name: Email changelog from README (pretty text)

on:
  workflow_run:
    # IMPORTANT:
    # - This must match the *exact* `name:` of your update workflow (the one that commits/pushes standards.csv/README.md).
    # - If the name is different, replace the value below.
    workflows: ["Update standards versions"]
    types: [completed]

permissions:
  contents: read

jobs:
  notify:
    # Send only when the update workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (the commit produced by the update workflow)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Extract latest changelog section from README (pretty text)
        id: extract
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e

          python3 - << 'PY'
          import re
          from pathlib import Path
          import os
          from datetime import datetime, timezone, timedelta

          text = Path("README.md").read_text(encoding="utf-8")

          # (KST) 날짜 표기 보정용
          KST = timezone(timedelta(hours=9))
          today_kst = datetime.now(KST).strftime("%Y-%m-%d")

          # 1) '## 변경 내역' 섹션 추출
          m = re.search(r"^##\s*변경\s*내역\s*$([\s\S]*)", text, re.MULTILINE)
          if not m:
              # 섹션 자체가 없으면: 변경내역 없음 메일로 처리 (실패하지 않음)
              latest_date = "NO_CHANGE"
              pretty_items = []
          else:
              changelog = m.group(1).strip()

              # 2) 가장 위에 있는 최신 날짜 블록 1개 추출
              #    ### YYYY-MM-DD
              #    - ...
              block_re = re.compile(
                  r"^###\s*(\d{4}-\d{2}-\d{2})\s*$\n"       # date header
                  r"((?:^\-\s+.*$\n?)*)",                     # bullets (0+ lines)
                  re.MULTILINE
              )

              blocks = list(block_re.finditer(changelog))
              if not blocks:
                  # 날짜 블록이 없으면: 변경내역 없음 메일로 처리 (실패하지 않음)
                  latest_date = "NO_CHANGE"
                  pretty_items = []
              else:
                  # README 규칙: 최신 항목이 최상단
                  latest = blocks[0]
                  latest_date = latest.group(1)
                  bullets_raw = latest.group(2) or ""

                  # 3) bullet 라인 정리
                  bullet_lines = []
                  for ln in bullets_raw.splitlines():
                      ln = ln.strip()
                      if ln.startswith("- "):
                          bullet_lines.append(ln[2:].strip())

                  pretty_items = [f"• {b}" for b in bullet_lines if b]

          # 4) 링크 구성
          server_url = os.environ.get("GITHUB_SERVER_URL", "https://github.com")
          repo = os.environ.get("GITHUB_REPOSITORY", "")
          repo_url = f"{server_url}/{repo}" if repo else server_url
          readme_url = f"{server_url}/{repo}/blob/main/README.md" if repo else ""
          csv_url = f"{server_url}/{repo}/blob/main/standards.csv" if repo else ""

          # 5) 최종 텍스트 본문 생성 (Markdown 없이)
          out = []
          out.append("표준 문서 변경 알림")
          out.append("")

          # 날짜 표기: NO_CHANGE면 KST 오늘 날짜를 표시(메일 가독성)
          if latest_date == "NO_CHANGE":
              out.append(f"날짜: {today_kst} (변경내역 없음)")
          else:
              out.append(f"날짜: {latest_date}")

          out.append("")
          out.append("변경 내역:")

          # ✅ 변경내역이 없으면 '변경내역 없음'으로 통일
          if pretty_items:
              out.extend(pretty_items)
          else:
              out.append("• 변경내역 없음")

          out.append("")
          out.append("바로가기:")
          if repo_url:
              out.append(f"- 저장소: {repo_url}")
          if readme_url:
              out.append(f"- README: {readme_url}")
          if csv_url:
              out.append(f"- CSV: {csv_url}")

          pretty_text = "\n".join(out) + "\n"

          Path("latest_changelog_pretty.txt").write_text(pretty_text, encoding="utf-8")
          Path("latest_date.txt").write_text(latest_date + "\n", encoding="utf-8")

          print("Latest changelog date:", latest_date)
          PY

      - name: Read extracted text
        id: readtxt
        run: |
          echo "LATEST_DATE=$(cat latest_date.txt)" >> $GITHUB_ENV
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          cat latest_changelog_pretty.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "표준 문서 변경 알림 (${{ env.LATEST_DATE }})"
          to: ${{ secrets.MAIL_TO }}
          from: "standards-version-tracker <${{ secrets.SMTP_USERNAME }}>"
          body: |
            ${{ env.CHANGELOG }}
